<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Details</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f5f5f7;
        margin: 0;
      }
      .container {
        max-width: 900px;
        margin: 40px auto;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 4px 32px rgba(0, 0, 0, 0.08);
        padding: 40px 24px;
      }
      .product-header {
        display: flex;
        flex-wrap: wrap;
        gap: 40px;
        align-items: center;
      }
      .product-image {
        max-width: 340px;
        width: 100%;
        border-radius: 14px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
        background: #f5f5f7;
      }
      .product-info {
        flex: 1;
        min-width: 260px;
      }
      .product-title {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 10px;
      }
      .product-category {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px;
      }
      .product-price {
        color: #0071e3;
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 18px;
      }
      .add-to-cart {
        background: #0071e3;
        color: #fff;
        border: none;
        border-radius: 24px;
        padding: 12px 32px;
        font-size: 1.08rem;
        cursor: pointer;
        transition: background 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px rgba(0, 113, 227, 0.08);
        font-weight: 600;
        margin-bottom: 18px;
      }
      .add-to-cart:hover {
        background: #005bb5;
      }
      .product-description {
        color: #444;
        font-size: 1.1rem;
        margin-bottom: 18px;
      }
      .specs-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 32px 0 12px 0;
      }
      .specs-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .specs-list li {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 1.05rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .back-link {
        display: inline-block;
        margin-bottom: 24px;
        color: #0071e3;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.1rem;
      }
      .back-link:hover {
        text-decoration: underline;
      }

      /* Styles for Colors Section */
      .colors-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid #eee;
      }
      .colors-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 12px;
      }
      .color-options {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .color-option {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid #ccc; /* Default border */
        transition: transform 0.1s ease-in-out, border-color 0.1s ease-in-out;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      }
      .color-option:hover {
        transform: scale(1.1);
        border-color: #0071e3;
      }
      /* Add specific styles for colors that need clearer borders */
      .color-option[style*="background-color: white"],
      .color-option[style*="background-color: #ffffff"] {
        border-color: #bbb; /* Darker border for white */
      }
      .color-option.selected {
        border-color: #0071e3; /* Highlight selected color */
        border-width: 3px;
      }

      /* Success state for Add to Cart button (copied from store.html) */
      .add-to-cart.success {
        background: #34c759; /* Apple Green */
        box-shadow: 0 2px 8px rgba(52, 199, 89, 0.2);
        pointer-events: none; /* Disable clicks during animation */
      }
      .add-to-cart.success:hover {
        background: #34c759;
        box-shadow: 0 2px 8px rgba(52, 199, 89, 0.2);
      } /* Keep green on hover */

      @media (max-width: 700px) {
        .container {
          padding: 12px 2vw;
        }
        .product-header {
          flex-direction: column;
          gap: 18px;
        }
        .product-title {
          font-size: 1.3rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="store.html" class="back-link">&larr; Back to Store</a>
      <div class="product-header">
        <img
          src=""
          alt="Product image"
          class="product-image"
          id="product-img"
        />
        <div class="product-info">
          <div class="product-title" id="product-title"></div>
          <div class="product-category" id="product-category"></div>
          <div class="product-price" id="product-price"></div>
          <button class="add-to-cart" id="add-to-cart-btn">Add to Cart</button>
          <div class="product-description" id="product-desc"></div>

          <!-- New section for colors -->
          <div class="colors-section">
            <div class="colors-title">Available Colors</div>
            <div class="color-options" id="color-options"></div>
            <div class="selected-color-text" id="selected-color-text"></div>
          </div>
        </div>
      </div>
      <div>
        <div class="specs-title">Technical Specifications</div>
        <ul class="specs-list" id="specs-list"></ul>
      </div>
    </div>
    <script>
      let currentProduct = null;
      let cart = JSON.parse(localStorage.getItem('cart')) || [];

      // Funcțiile addToCart și updateCartCount mutate aici pentru a fi definite la început
      function addToCart(product) {
        const existingItem = cart.find(item => item.id === product.id);
        if (existingItem) {
          existingItem.quantity++;
        } else {
          cart.push({ ...product, quantity: 1 });
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount(true);
        console.log('Added to cart:', product.name);
      }

      function updateCartCount(animate) {
        const cartCountElement = document.querySelector('.cart-count');
        if (cartCountElement) {
          const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
          
          if (totalItems > 0) {
              cartCountElement.textContent = totalItems;
              cartCountElement.style.display = 'flex'; // Afisam elementul
          } else {
              cartCountElement.textContent = '0'; // Optionally keep 0, or just let it be empty if hidden by CSS
              cartCountElement.style.display = 'none'; // Ascundem elementul
          }

          if (animate) {
            cartCountElement.classList.add('animate');
            cartCountElement.addEventListener('animationend', () => {
              cartCountElement.classList.remove('animate');
            }, { once: true });
          }
        }
      }

      function getProductIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
      }

      async function fetchProductDetails(productId) {
        try {
          const response = await fetch(`http://localhost:3000/api/products/${productId}`);
          if (!response.ok) {
            if (response.status === 404) {
              document.getElementById('product-title').textContent = 'Product Not Found';
              document.getElementById('product-desc').textContent = 'The product you are looking for does not exist.';
              document.getElementById('product-price').textContent = '';
              document.getElementById('product-img').src = '';
              document.getElementById('add-to-cart-btn').style.display = 'none';
              document.getElementById('specs-list').innerHTML = '';
              document.getElementById('color-options').innerHTML = '';
              document.getElementById('selected-color-text').textContent = '';
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          currentProduct = data.product || data;
          console.log('Product fetched:', currentProduct);
          updateProductDetails(currentProduct);
        } catch (error) {
          console.error('Error fetching product details:', error);
          document.getElementById('product-title').textContent = 'Error Loading Product';
          document.getElementById('product-desc').textContent = 'Could not load product details. Please try again later.';
          document.getElementById('product-price').textContent = '';
          document.getElementById('product-img').src = '';
          document.getElementById('add-to-cart-btn').style.display = 'none';
          document.getElementById('specs-list').innerHTML = '';
          document.getElementById('color-options').innerHTML = '';
          document.getElementById('selected-color-text').textContent = '';
        }
      }

      function updateProductDetails(product) {
        if (!product) return;

        const imageSrc = product.image || product.image_url || '';
        document.getElementById('product-img').src = imageSrc;
        document.getElementById('product-img').alt = product.name || 'Product image';
        document.getElementById('product-title').textContent = product.name || '';
        document.getElementById('product-category').textContent = product.category ? `Category: ${product.category}` : 'Category: -';
        const priceValue = parseFloat(product.price);
        document.getElementById('product-price').textContent = Number.isFinite(priceValue) ? `$${priceValue.toFixed(2)}` : '';
        document.getElementById('product-desc').textContent = product.description || '';
        const specsList = document.getElementById('specs-list');
        specsList.innerHTML = '';
        const specs = Array.isArray(product.specs)
          ? product.specs
          : typeof product.specs === 'string'
            ? product.specs.split(',').map((s) => s.trim()).filter(Boolean)
            : [];
        if (specs.length > 0) {
          specs.forEach((spec) => {
            const li = document.createElement('li');
            li.textContent = spec;
            specsList.appendChild(li);
          });
        }

        // Display colors
        const colorOptionsContainer = document.getElementById('color-options');
        const colorMap = {
          // Mapping Apple color names to CSS values
          Silver: '#c0c0c0',
          'Space Gray': '#505050',
          Midnight: '#202020',
          Starlight: '#f0e8d5',
          Gold: '#d4af37',
          Pink: '#ffc0cb',
          Purple: '#a020f0',
          Blue: '#0000ff',
          Green: '#008000',
          Yellow: '#ffff00',
          Orange: '#ffa500',
          Red: '#ff0000',
          'Black Titanium': '#454545',
          'White Titanium': '#f8f8ff',
          'Blue Titanium': '#6b7a8a',
          'Natural Titanium': '#c5c5c5',
          White: '#ffffff', // Ensure white is explicitly mapped
          // Add more colors as needed
        };

        const colors = Array.isArray(product.colors)
          ? product.colors
          : typeof product.colors === 'string'
            ? product.colors.split(',').map((c) => c.trim()).filter(Boolean)
            : [];
        if (colors.length > 0) {
          colors.forEach((colorName) => {
            const colorEl = document.createElement('div');
            colorEl.className = 'color-option';

            // Use the color map or fallback to lowercase name
            const cssColor = colorMap[colorName] || colorName.toLowerCase().replace(/ /g, '');
            colorEl.style.backgroundColor = cssColor;

            colorEl.title = colorName; // Tooltip with color name
            // Add click event for color selection
            colorEl.addEventListener('click', () => {
              // Remove selected class from all color options
              document.querySelectorAll('.color-option').forEach((option) => {
                option.classList.remove('selected');
              });
              // Add selected class to the clicked option
              colorEl.classList.add('selected');

              // Display the name of the selected color
              const selectedColorTextElement = document.getElementById('selected-color-text');
              if (selectedColorTextElement) {
                selectedColorTextElement.textContent = `Selected: ${colorName}`; // Update text with selected color name
              }
            });

            colorOptionsContainer.appendChild(colorEl);
          });

          // Select the first color by default if colors are available
          const firstColorOption = colorOptionsContainer.querySelector('.color-option');
          if (firstColorOption) {
            firstColorOption.classList.add('selected');
            // Display the name of the initially selected color
            const selectedColorTextElement = document.getElementById('selected-color-text');
            if (selectedColorTextElement) {
              selectedColorTextElement.textContent = `Selected: ${firstColorOption.title}`; // Initial text
            }
          }
        } else {
          const colorsSection = document.querySelector('.colors-section');
          if (colorsSection) colorsSection.style.display = 'none'; // Hide section if no colors
        }

        document.getElementById('add-to-cart-btn').onclick = function () {
          let cart = JSON.parse(localStorage.getItem('cart')) || [];

          // Get selected color
          const selectedColorElement = document.querySelector('.color-option.selected');
          const selectedColor = selectedColorElement ? selectedColorElement.title : colors.length > 0 ? colors[0] : 'Default';

          // Create a cart item object with the expected structure
            const cartItem = {
              id: product.id || product.product_id,
              name: product.name,
              description: product.description,
              price: parseFloat(product.price) || 0,
              image: imageSrc,
              color: selectedColor,
              quantity: 1
            };

          const existingWithColor = cart.find((item) => item.id === cartItem.id && item.color === cartItem.color);

          if (existingWithColor) {
            existingWithColor.quantity += 1;
          } else {
            // Add new item with color
            cart.push(cartItem);
          }
          localStorage.setItem('cart', JSON.stringify(cart));
          // window.location.href = 'store.html'; // Remove redirect

          // Add animation (copied from store.html)
          const button = document.getElementById('add-to-cart-btn');
          const originalText = button.textContent;

          button.textContent = 'Added!';
          button.classList.add('animated', 'success'); /* Add success class for styling */
          button.disabled = true; // Disable button temporarily

          // Remove animation classes and revert text after a delay
          setTimeout(() => {
            button.classList.remove('animated', 'success');
            button.textContent = originalText;
            button.disabled = false; // Re-enable button

            // Optional: redirect after animation completes
            window.location.href = 'store.html';
          }, 2000); // Animation duration + slight delay
        };

        // Initialize cart count on page load
        updateCartCount(false);
      }

      // Select color logic
      let selectedColor = ''; // Store the currently selected color

      function selectColor(color, element) {
        // Remove 'selected' class from all color options
        document.querySelectorAll('.color-option').forEach(option => {
          option.classList.remove('selected');
        });

        // Add 'selected' class to the clicked color option
        element.classList.add('selected');
        selectedColor = color;
        document.getElementById('selected-color-text').textContent = `Selected Color: ${selectedColor}`;
      }

      // Inițializăm la încărcarea paginii
      document.addEventListener('DOMContentLoaded', () => {
        const productId = getProductIdFromUrl();
        if (productId) {
          fetchProductDetails(productId);
        } else {
          document.getElementById('product-title').textContent = 'No Product ID Provided';
          document.getElementById('product-desc').textContent = 'Please navigate from the store page or provide a valid product ID in the URL.';
          document.getElementById('add-to-cart-btn').style.display = 'none';
        }

        // Inițializăm numărul de produse din coș la încărcare (această este apelarea corectă la încărcarea paginii)
        updateCartCount(false);
      });
    </script>
  </body>
</html>
